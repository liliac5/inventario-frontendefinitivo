<div class="reportes-docente-container">
  <app-sidebar></app-sidebar>

  <div class="main-content">
    <div class="header">
      <h1 class="welcome">¡Bienvenido/a, <span class="user-name">{{ currentUser }}</span>!</h1>
    </div>

    <div class="content-area">
      <div class="main-title-section">
        <div>
          <h2 class="main-title">Reportes de Incidencias</h2>
          <p class="main-subtitle">Registra daños y consulta el historial de reportes.</p>
        </div>
      </div>

      <div class="content-grid">
        <!-- Formulario de Crear Reporte -->
        <div class="form-section">
          <div class="section-header">
            <div>
              <h3 class="section-title">Reportar Bien Dañado</h3>
              <p class="section-subtitle">Completa los datos del incidente.</p>
            </div>
          </div>
          
          <form (ngSubmit)="enviarReporte()">
            <div class="form-group">
              <label for="bien">Elemento Afectado</label>
              <select
                id="bien"
                [(ngModel)]="bienSeleccionado"
                name="bien"
                required
                class="form-select">
                <option [ngValue]="null">Seleccione un bien</option>
                <option *ngFor="let bien of getBienesDisponibles()" [ngValue]="bien.idBien">
                  {{ bien.nombreBien }} - {{ bien.aula?.nombre || 'Sin aula' }}
                </option>
                <option *ngIf="getBienesDisponibles().length === 0" disabled>
                  No hay bienes disponibles en sus aulas asignadas
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="tipo">Tipo de Incidencia</label>
              <select 
                id="tipo"
                name="tipo"
                [(ngModel)]="tipoIncidencia"
                class="form-select"
                required>
                <option value="">Seleccione el tipo de incidencia</option>
                <option *ngFor="let tipo of tiposIncidencia" [value]="tipo">
                  {{ tipo }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="detalle">Detalle del Problema</label>
              <textarea 
                id="detalle"
                name="detalle"
                [(ngModel)]="detalleProblema"
                class="form-textarea"
                placeholder="Describa detalladamente el problema o daño observado..."
                rows="6"
                required></textarea>
            </div>

            <button type="submit" class="btn-enviar">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" class="icon">
                <path d="M2 4L10 10L18 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <rect x="2" y="4" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
              Enviar Reporte
            </button>
          </form>
        </div>

        <!-- Historial de Reportes -->
        <div class="history-section">
          <div class="section-header">
            <div>
              <h3 class="section-title">Mis Reportes</h3>
              <p class="section-subtitle">Seguimiento de incidencias registradas.</p>
            </div>
            <span class="section-count">{{ misReportes.length }} reportes</span>
          </div>
          
          <div class="table-container">
            <table class="reportes-table">
              <thead>
                <tr>
                  <th>ESTADO</th>
                  <th>ELEMENTO AFECTADO</th>
                  <th>TIPO DE INCIDENCIA</th>
                  <th>REPORTADO POR</th>
                  <th>FECHA/HORA</th>
                  <th>DETALLE DEL PROBLEMA</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let reporte of misReportes">
                  <td>
                    <div class="status-cell">
                      <span class="status-dot" 
                            [class.pendiente]="getEstadoClass(reporte.estado) === 'pendiente'"
                            [class.reparacion]="getEstadoClass(reporte.estado) === 'reparacion'"
                            [class.resuelto]="getEstadoClass(reporte.estado) === 'resuelto'">
                      </span>
                      <span class="status-text">{{ reporte.estado }}</span>
                    </div>
                  </td>
                  <td class="elemento-cell">{{ reporte.elementoAfectado || 'Cargando...' }}</td>
                  <td class="tipo-cell">{{ reporte.tipoIncidencia || reporte.tipo_incidencia || '-' }}</td>
                  <td class="reportado-cell">{{ reporte.reportadoPor || currentUser }}</td>
                  <td class="fecha-cell">{{ formatFechaHora(reporte.fechaHora || reporte.fecha_hora) }}</td>
                  <td class="detalle-cell">
                    <span [title]="reporte.detalleProblema || reporte.detalle_problema || 'Sin detalle'">
                      {{ truncateText(reporte.detalleProblema || reporte.detalle_problema || '', 60) || '-' }}
                    </span>
                    <button class="view-detail-btn" (click)="viewDetails(reporte)" title="Ver detalles">
                      Ver
                    </button>
                  </td>
                </tr>
                <tr *ngIf="misReportes.length === 0">
                  <td colspan="6" class="no-data">No hay reportes registrados</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalles -->
<div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
  <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeDetailModal()">×</button>
    <h2 class="modal-title">Detalles del Reporte</h2>
    
    <div class="detail-content" *ngIf="selectedReporte">
      <div class="detail-row">
        <span class="detail-label">Estado:</span>
        <span class="status-badge-modal" 
              [class.pendiente]="getEstadoClass(selectedReporte.estado) === 'pendiente'"
              [class.reparacion]="getEstadoClass(selectedReporte.estado) === 'reparacion'"
              [class.resuelto]="getEstadoClass(selectedReporte.estado) === 'resuelto'">
          {{ selectedReporte.estado }}
        </span>
      </div>
      
      <div class="detail-row">
        <span class="detail-label">Elemento Afectado:</span>
        <span class="detail-value">{{ selectedReporte.elementoAfectado || 'Sin información' }}</span>
      </div>
      
      <div class="detail-row">
        <span class="detail-label">Tipo de Incidencia:</span>
        <span class="detail-value">{{ selectedReporte.tipoIncidencia || selectedReporte.tipo_incidencia || 'Sin tipo' }}</span>
      </div>
      
      <div class="detail-row">
        <span class="detail-label">Reportado Por:</span>
        <span class="detail-value">{{ selectedReporte.reportadoPor || currentUser }}</span>
      </div>
      
      <div class="detail-row">
        <span class="detail-label">Fecha/Hora:</span>
        <span class="detail-value">{{ formatFechaHora(selectedReporte.fechaHora || selectedReporte.fecha_hora) }}</span>
      </div>
      
      <div class="detail-row full-width">
        <span class="detail-label">Detalle del Problema:</span>
        <p class="detail-text">{{ selectedReporte.detalleProblema || selectedReporte.detalle_problema || 'Sin detalle disponible' }}</p>
      </div>
    </div>
    
    <div class="modal-actions">
      <button type="button" class="btn-close-modal" (click)="closeDetailModal()">Cerrar</button>
    </div>
  </div>
</div>

