<div class="usuarios-container">
  <app-sidebar></app-sidebar>
  
  <div class="main-content">
    <div class="header">
      <h1 class="welcome">¬°Bienvenido/a, <span class="user-name">{{ currentUser }}</span>!</h1>
    </div>

    <div class="content-area">
      <h2 class="page-title">GESTION DE USUARIOS</h2>

      <div class="content-card">
        <div class="actions-bar">
          <div class="search-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
              <circle cx="9" cy="9" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <path d="M13 13 L17 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <input 
              type="text" 
              class="search-input" 
              placeholder="Buscar por nombre..."
              [(ngModel)]="searchTerm"
              (input)="onSearch()">
          </div>
          <button class="add-button" (click)="openAddModal()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 5 L10 15 M5 10 L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Crear Usuario
          </button>
        </div>

        <div class="table-container">
          <table class="usuarios-table">
            <thead>
              <tr>
                <th>Nombre Completo</th>
                <th>C√©dula</th>
                <th>Rol</th>
                <th>Fecha Registro</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let usuario of filteredUsuarios">
                <td>{{ getNombreCompleto(usuario) }}</td>
                <td>{{ getCedula(usuario) }}</td>
                <td>
                  <span class="rol-badge" 
                        [class.admin]="getRolNombre(usuario.idRol, usuario) === 'Admin' || getRolNombre(usuario.idRol, usuario) === 'ADMINISTRADOR' || getRolNombre(usuario.idRol, usuario) === 'Administrador'" 
                        [class.coordinador]="getRolNombre(usuario.idRol, usuario) === 'Coordinador' || getRolNombre(usuario.idRol, usuario) === 'COORDINADOR'" 
                        [class.docente]="getRolNombre(usuario.idRol, usuario) === 'Docente' || getRolNombre(usuario.idRol, usuario) === 'DOCENTE'"
                        [class.usuario]="getRolNombre(usuario.idRol, usuario) === 'Usuario' || getRolNombre(usuario.idRol, usuario) === 'USUARIO'">
{{ usuario.rol?.nombre || getRolNombre(usuario.idRol, usuario) }}
                  </span>
                </td>
                <td>{{ formatDate(usuario.fechaRegistro) }}</td>
                <td>
                  <span class="status-badge" [class.active]="usuario.estado" [class.inactive]="!usuario.estado">
                    {{ usuario.estado ? 'Activo' : 'Inactivo' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="action-btn delete-btn" (click)="deleteUsuario(usuario)" title="Eliminar">
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                        <path d="M5 5 L15 15 M15 5 L5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                    <button class="action-btn edit-btn"
                      (click)="openEditModal(usuario)"
                       title="Editar">
                        <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                         <path d="M4 14 L14 4" stroke="currentColor" stroke-width="2"/>
                       <path d="M4 14 L4 16 L6 16 L16 6 L14 4 Z"
                            stroke="currentColor"
                            stroke-width="2"
                            fill="none"/>
                       </svg>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filteredUsuarios.length === 0">
                <td colspan="6" class="no-data">No hay usuarios registrados</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Crear Usuario -->
<div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeAddModal()">√ó</button>
    <div class="modal-header">
      <h2 class="modal-title">Crear Usuario</h2>
      <p class="modal-subtitle">Ingrese la c√©dula para cargar los datos.</p>
      <div class="modal-steps">
        <span class="step-chip" [class.active]="true">1. Identificaci√≥n</span>
        <span class="step-chip" [class.active]="hasNombreEncontrado() && !usuarioYaCreado">2. Acceso</span>
        <span class="step-chip" [class.active]="hasNombreEncontrado() && !usuarioYaCreado">3. Registro</span>
      </div>
    </div>
    
    <form class="modal-form grid-form"
          #formUsuario="ngForm"
          (ngSubmit)="saveUsuario()">

      <div class="form-section">
        <h3 class="section-title">Identificaci√≥n</h3>
        <div class="form-grid">
          <div class="form-field">
            <label>C√©dula *</label>
            <input type="text"
                   name="cedula"
                   [(ngModel)]="nuevoUsuario.cedula"
                   placeholder="Ingrese la c√©dula"
                   required
                   inputmode="numeric"
                   pattern="\\d*"
                   (input)="onCedulaInput()"
                   #cedula="ngModel">

            <small class="error" *ngIf="cedulaError">
              {{ cedulaError }}
            </small>
          </div>

          <div class="form-field full-width" *ngIf="hasNombreEncontrado() && !usuarioYaCreado">
            <label>Nombre Completo *</label>
            <input type="text"
                   name="nombre"
                   [(ngModel)]="nuevoUsuario.nombres_completos"
                   placeholder="Se carga autom√°ticamente"
                   readonly
                   disabled
                   required
                   #nombre="ngModel">
          </div>
        </div>

        <div class="status-row">
          <small class="info" *ngIf="isCedulaLoading">Cargando usuario...</small>
          <small class="info" *ngIf="!isCedulaLoading && !cedulaError && !hasNombreEncontrado()">
            Ingrese la c√©dula para cargar el usuario.
          </small>
        </div>
      </div>

      <div class="form-section" *ngIf="hasNombreEncontrado() && !usuarioYaCreado">
        <h3 class="section-title">Acceso</h3>
        <div class="form-grid">
          <div class="form-field">
            <label>Contrase√±a *</label>
            <div class="input-wrapper">
              <input [type]="showPassword ? 'text' : 'password'"
                     name="password"
                     [(ngModel)]="passwordTemp"
                     placeholder="Contrase√±a segura"
                     required
                     minlength="8"
                     pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$"
                     #password="ngModel">

              <button type="button"
                      class="eye-icon"
                      (click)="togglePasswordVisibility()">
                üëÅ
              </button>
            </div>

            <small class="error" *ngIf="password.invalid && password.touched">
              <span *ngIf="password.errors?.['required']">La contrase√±a es obligatoria.</span>
              <span *ngIf="password.errors?.['minlength']">M√≠nimo 8 caracteres.</span>
              <span *ngIf="password.errors?.['pattern']">
                Debe contener may√∫scula, min√∫scula y n√∫mero.
              </span>
            </small>
          </div>

          <div class="form-field">
            <label>Rol *</label>
            <select name="idRol"
                    [(ngModel)]="nuevoUsuario.idRol"
                    required
                    #rol="ngModel">
              <option [ngValue]="0">Seleccione un rol</option>
              <option *ngFor="let rol of roles" [ngValue]="rol.idRol">
                {{ rol.nombre }}
              </option>
            </select>

            <small class="error" *ngIf="rol.invalid && rol.touched">
              Debe seleccionar un rol.
            </small>
          </div>
        </div>
      </div>

      <div class="form-section" *ngIf="hasNombreEncontrado() && !usuarioYaCreado">
        <h3 class="section-title">Registro</h3>
        <div class="form-grid">
          <div class="form-field">
            <label>Fecha de Registro</label>
            <input type="date"
                   name="fechaRegistro"
                   [value]="today"
                   readonly
                   disabled>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="submit"
                class="btn-save"
                [disabled]="usuarioYaCreado">
          Guardar Usuario
        </button>

        <button type="button"
                class="btn-cancel"
                (click)="closeAddModal()">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeEditModal()">√ó</button>
    <div class="modal-header">
      <h2 class="modal-title">Editar Usuario</h2>
      <p class="modal-subtitle">Actualice rol, estado o contrase√±a.</p>
    </div>

    <form class="modal-form grid-form" (ngSubmit)="updateUsuario()">
      <div class="form-section">
        <h3 class="section-title">Identificaci√≥n</h3>
        <div class="form-grid">
          <div class="form-field full-width">
            <label>Nombre Completo *</label>
            <input type="text"
                   [(ngModel)]="nuevoUsuario.nombres_completos"
                   name="nombre"
                   readonly
                   disabled
                   required>
          </div>

          <div class="form-field">
            <label>C√©dula *</label>
            <input type="text"
                   [(ngModel)]="nuevoUsuario.cedula"
                   name="cedula"
                   readonly
                   disabled
                   required>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Acceso</h3>
        <div class="form-grid">
          <div class="form-field">
            <label>Contrase√±a (opcional)</label>
            <div class="input-wrapper">
              <input [type]="showPassword ? 'text' : 'password'"
                     [(ngModel)]="editPasswordTemp"
                     name="editPassword"
                     placeholder="Nueva contrase√±a"
                     minlength="8"
                     pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).+$"
                     #editPassword="ngModel">

              <button type="button"
                      class="eye-icon"
                      (click)="togglePasswordVisibility()">
                üëÅ
              </button>
            </div>

            <small class="error" *ngIf="editPassword.invalid && editPassword.touched">
              <span *ngIf="editPassword.errors?.['minlength']">M√≠nimo 8 caracteres.</span>
              <span *ngIf="editPassword.errors?.['pattern']">
                Debe contener may√∫scula, min√∫scula y n√∫mero.
              </span>
            </small>
          </div>

          <div class="form-field">
            <label>Rol *</label>
            <select [(ngModel)]="nuevoUsuario.idRol" name="idRol" required>
              <option *ngFor="let rol of roles" [value]="rol.idRol">
                {{ rol.nombre }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Estado</h3>
        <div class="form-grid">
          <div class="form-field">
            <label>Estado</label>
            <select [(ngModel)]="nuevoUsuario.estado" name="estado">
              <option [ngValue]="true">Activo</option>
              <option [ngValue]="false">Inactivo</option>
            </select>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn-save">Guardar Cambios</button>
        <button type="button" class="btn-cancel" (click)="closeEditModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

